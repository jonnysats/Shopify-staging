{%- liquid
	comment
	# Calculate the max amount of related collections
	endcomment
	assign collections_size = 0
	for product_collection in product.collections
		unless collection.handle == 'all' or collection.handle == 'frontpage'
			assign collections_size = collections_size | plus: 1
		endunless
	endfor
-%}
{%- if collections_size > 0 -%}
	{%- liquid
		render 'section-padding', padding_amount_top: section.settings.padding_amount_top, padding_amount_bottom: section.settings.padding_amount_bottom
		assign flickity_arrows = false
		assign flickity_dots = false
		assign flickity_loop = true 
		assign flickity_group_cells = false
		assign flickity_adaptive_height = false
	-%}
	{{ 'product-from-the-same-collection.css' | asset_url | stylesheet_tag: preload: true }}
	<script src="{{ 'featured-collection-slider.js' | asset_url }}" defer crossorigin="anonymous"></script>
	<div class="product-grid product-grid-overflow product-slider" data-section-id="{{ section.id }}" data-section-type="featuredCollectionSlider">
		{%- if section.settings.heading != blank -%}
			<div class="container pb-lg-4 mb-lg-2">
				<div class="row align-items-center">
					<div class="col col-lg-5 pb-3 pb-lg-0">
						<h2 class="header px-1 px-lg-0 pb-1 pb-lg-0 mb-lg-0">{{ section.settings.heading }}</h2>
					</div>
					<div class="col-7 d-none d-lg-block">
						{%- render 'slider-custom-nav-buttons', justify_style: "end" -%}
					</div>
				</div>
			</div>
		{%- endif -%}
		<div class="featured-collection-slider-container container-fluid">
			<div class="special-margin">
				<div class="row gx-0 w-100 h-100" data-generic-slider data-arrows="{{ flickity_arrows }}" data-dots="{{ flickity_dots }}" data-loop="{{ flickity_loop }}" data-adaptive-height="{{ flickity_adaptive_height }}" data-group-cells="{{ flickity_group_cells }}">
					{%- liquid
						assign product_grid_classes = "pe-3 pe-md-4 pe-lg-custom col-custom col-6 col-md-4 col-lg-3 col-lg-custom"
						
						comment
						# Loop for each collection from the current product
						endcomment
						for collection in product.collections
							comment
							# Avoid collections from convoluted collections
							endcomment
							unless collection.handle == 'all' or collection.handle == 'frontpage' or collection.handle == 'new-arrivals'
								comment
								# Display products from this collection
								endcomment
								for related_product in collection.products
									comment
									# Avoid showing the same product in loop
									endcomment
									if related_product.id != product.id
										comment
										# First tag (New)
										endcomment
										assign first_tag = nil
										if related_product.metafields.theme.new == true
											assign first_tag = 'New'
										endif

										comment
										# Second tag (% OFF)
										endcomment
										assign second_tag = nil

										if section.settings.show_percent_off == true
											capture discount_percentage
												render "product-price-discount-percentage", product: related_product
											endcapture
											
											assign discount_percentage = discount_percentage | strip
											
											if discount_percentage != nil and discount_percentage != blank and discount_percentage != ""
												assign second_tag = discount_percentage | append: '% Off'
											endif
										endif

										comment
										# Exclude items that are samples, using tags
										endcomment
										if related_product.tags.size > 0
											comment
											# Validate possible samples tag names
											endcomment
											assign sample_product = false
											assign samples_tags = "sample,samples"

											comment
											# Loop for each visible product tag and validate if is a sample or not
											endcomment
											for tag in related_product.tags
												assign lower_tag = tag | downcase

												comment
												# If current product is a sample we exclude it from carousel
												endcomment
												if samples_tags contains lower_tag
													assign sample_product = true
												endif
											endfor
										endif

										comment
										# Skip product samples from carousel
										endcomment
										if sample_product == true
											continue
										endif

										comment
										# Render Grid Item
										endcomment
										render 'product-grid', product: related_product, classes: product_grid_classes, col_sm: 2, col_md: 3, col_lg: 4, show_description: section.settings.show_description, show_swatches: section.settings.show_swatches, first_tag: first_tag, second_tag: second_tag
									endif
								endfor
							endunless
						endfor
					-%}
				</div>
			</div>
		</div>
		<div class="container d-block d-lg-none mt-4">
			<div class="row">
				<div class="col">
					{%- render 'slider-custom-nav-buttons', justify_style: "between" -%}
				</div>
			</div>
		</div>
	</div>
{%- endif -%}
{% schema %}
{
	"name": "From the same collection",
	"tag": "section",
	"class": "section-collection-merchandising-slider section-from-the-same-collection",
	"settings": [
		{
			"type": "header",
			"content": "Content",
			"info": "Products in the slider will come from related collections."
		},
		{
			"type": "text",
			"id": "heading",
			"label": "Header",
			"default": "from the same collection"
		},
		{
			"type": "header",
			"content": "Product Grid Options",
		},
		{
			"type": "checkbox",
			"id": "show_description",
			"default": true,
			"label": "Show description"
		},
		{
			"type": "checkbox",
			"id": "show_swatches",
			"default": true,
			"label": "Show Swatches"
		},
		{
			"type": "checkbox",
			"id": "show_percent_off",
			"label": "Show % Discount On Product Grid Images",
			"default": true
		},
		{
			"type": "header",
			"content": "Section Settings"
		},
		{
			"type": "select",
			"id": "padding_amount_top",
			"label": "Top Section Padding",
			"options": [
				{
					"value": "no",
					"label": "None"
				},
				{
					"value": "small",
					"label": "Small"
				},
				{
					"value": "default",
					"label": "Medium (Default)"
				},
				{
					"value": "large",
					"label": "Large"
				},
				{
					"value": "xlarge",
					"label": "Extra Large"
				}
			],
			"default": "default"
		},
		{
			"type": "select",
			"id": "padding_amount_bottom",
			"label": "Bottom Section Padding",
			"options": [
				{
					"value": "no",
					"label": "None"
				},
				{
					"value": "small",
					"label": "Small"
				},
				{
					"value": "default",
					"label": "Medium (Default)"
				},
				{
					"value": "large",
					"label": "Large"
				},
				{
					"value": "xlarge",
					"label": "Extra Large"
				}
			],
			"default": "default"
		}
	],
	"presets": [
		{
			"name": "From the same collection"
		}
	],
	"enabled_on": {
		"templates": ["product"]
	}
}
{% endschema %}