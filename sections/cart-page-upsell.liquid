{%- liquid

	comment
	# CART LOGIC
	endcomment
	
	comment
	# Build an array of upsell products from metafields in cart line items
	# ?REFERENCE: https://ellodave.dev/blog/article/advanced-liquid-arrays/
	endcomment
	assign upsell_metafield_products = null | sort

	for item in cart.items
		comment
		# Grab current set of product ids in upsell array to filter out duplicates
		endcomment
		assign ids = upsell_metafield_products | map: "id" | join: ","
		
		if item.product.metafields.theme.upsell_product_list.value != blank
			for product in item.product.metafields.theme.upsell_product_list.value
				assign product_id = product.id | append: ''
				unless ids contains product_id
					comment
					# We use a temporal (temp) variable to grab the product and apply the "sort" filter to be able to concatenate it on next line
					# ?NOTE: Refer to reference above for further context
					endcomment
					assign temp = product | sort
					assign upsell_metafield_products = upsell_metafield_products | concat: temp
				endunless
			endfor
		endif
	endfor
	
	comment
	# Grab length of cart upsell fallback product list
	# ?NOTE: "section.settings.cart_upsell_fallback_product_list.size" returns blank
	endcomment
	assign fallback_product_list_count = 0
	for product in section.settings.cart_upsell_fallback_product_list
		assign fallback_product_list_count = forloop.length
		break
	endfor
	
	comment
	# Build a final array of upsell items filtering out any items that might already be in cart or are unavailable
	endcomment
	assign upsell_products = null | sort
	assign cart_items_ids = cart.items | map: "product_id"
	if upsell_metafield_products.size > 0
		for product in upsell_metafield_products
			if product.available == true
				unless cart_items_ids contains product.id
					assign temp = product | sort
					assign upsell_products = upsell_products | concat: temp
				endunless
			endif
		endfor
	elsif fallback_product_list_count > 0
		comment
		# If there aren't any upsell products from cart line metafields, use fallback list
		endcomment
		for product in section.settings.cart_upsell_fallback_product_list
			if product.available == true
				unless cart_items_ids contains product.id
					assign temp = product | sort
					assign upsell_products = upsell_products | concat: temp
				endunless
			endif
		endfor
	endif
	
	comment
	# Grab final upsell products length
	endcomment
	assign product_count = upsell_products.size	
-%}
{%- if product_count > 0 -%}
	{%- liquid
		render 'section-padding', padding_amount_top: section.settings.padding_amount_top, padding_amount_bottom: section.settings.padding_amount_bottom
		assign flickity_arrows = false
		assign flickity_dots = false
		assign flickity_loop = false 
		assign flickity_group_cells = true
		assign flickity_adaptive_height = false
	-%}
	{{ 'cart-page-upsell.css' | asset_url | stylesheet_tag: preload: true }}
	<script src="{{ 'featured-collection-slider.js' | asset_url }}" defer crossorigin="anonymous"></script>
	<div class="product-grid product-grid-overflow product-slider" data-section-id="{{ section.id }}" data-section-type="featuredCollectionSlider">
		{%- if section.settings.heading != blank -%}
			<div class="container-xxl gx-lg-6">
				<div class="row">
					<div class="col pb-3 pb-lg-4{% if product_count > 4 %} col-lg-5{% endif %}">
						<h2 class="header">{{ section.settings.heading }}</h2>
					</div>
					{%- if product_count > 4 -%}
					<div class="col-7 d-none d-lg-block">
						{%- render 'slider-custom-nav-buttons', justify_style: "end" -%}
					</div>
					{%- endif -%}
				</div>
			</div>
		{%- endif -%}
		<div class="container-xxl gx-lg-6">
			<div class="row gx-0 w-100 h-100{% if product_count > 4 %} upsell-enable-flickity{% else %} upsell-overflow-slider flex-nowrap{% endif %}" data-generic-slider data-arrows="{{ flickity_arrows }}" data-dots="{{ flickity_dots }}" data-loop="{{ flickity_loop }}" data-adaptive-height="{{ flickity_adaptive_height }}" data-group-cells="{{ flickity_group_cells }}">
				{%- liquid
					for product_item in upsell_products limit: section.settings.number_of_products
						assign product_grid_classes = "me-3 me-md-4 col-custom"
						
						comment
							First tag (New)
						endcomment
						assign first_tag = nil
						if product_item.metafields.theme.new == true
							assign first_tag = 'New'
						endif

						comment
							Second tag (% OFF)
						endcomment
						assign second_tag = nil

						if section.settings.show_percent_off == true
							capture discount_percentage
								render "product-price-discount-percentage", product: product_item
							endcapture
							
							assign discount_percentage = discount_percentage | strip
							
							if discount_percentage != nil and discount_percentage != blank and discount_percentage != ""
								assign second_tag = discount_percentage | append: '% Off'
							endif
						endif

						comment
							Grid Item
						endcomment
						render 'product-grid', product: product_item, classes: product_grid_classes, col_sm: 2, col_md: 3, col_lg: 4, show_description: section.settings.show_description, show_swatches: section.settings.show_swatches, first_tag: first_tag, second_tag: second_tag, lazyloading_style: "lazy"
					endfor
				-%}
			</div>
		</div>
		{%- if product_count > 4 -%}
			<div class="container-xxl gx-lg-6 d-block d-lg-none mt-4">
				<div class="row">
					<div class="col">
						{%- render 'slider-custom-nav-buttons', justify_style: "between" -%}
					</div>
				</div>
			</div>
		{%- endif -%}
	</div>
{%- endif -%}
{% schema %}
{
	"name": "Cart page upsell",
	"tag": "section",
	"class": "section-cart-page-upsell",
	"settings": [
		{
			"type": "header",
			"content": "Content",
			"info": "Products in the slider will come from fallback list or metafields from products in cart"
		},
		{
			"type": "text",
			"id": "heading",
			"label": "Header"
		},
		{
			"type": "product_list",
			"id": "cart_upsell_fallback_product_list",
			"label": "Cart Upsell Fallback product list",
			"info": "This list is used when no products in the current cart have no up-sell products to show",
			"limit": 20
		},
		{
			"type": "header",
			"content": "Product Grid Options",
		},
		{
			"type": "checkbox",
			"id": "show_description",
			"default": true,
			"label": "Show description"
		},
		{
			"type": "checkbox",
			"id": "show_swatches",
			"default": true,
			"label": "Show swatches"
		},
		{
			"type": "checkbox",
			"id": "show_percent_off",
			"label": "Show % discount on product grid images",
			"default": true
		},
		{
			"type": "range",
			"id": "number_of_products",
			"min": 6,
			"max": 50,
			"step": 4,
			"default": 22,
			"label": "Products Per Collection"
		},
		{
			"type": "header",
			"content": "Section Settings"
		},
		{
			"type": "select",
			"id": "padding_amount_top",
			"label": "Top Section Padding",
			"options": [
				{
					"value": "no",
					"label": "None"
				},
				{
					"value": "small",
					"label": "Small"
				},
				{
					"value": "default",
					"label": "Medium (Default)"
				},
				{
					"value": "large",
					"label": "Large"
				},
				{
					"value": "xlarge",
					"label": "Extra Large"
				}
			],
			"default": "default"
		},
		{
			"type": "select",
			"id": "padding_amount_bottom",
			"label": "Bottom Section Padding",
			"options": [
				{
					"value": "no",
					"label": "None"
				},
				{
					"value": "small",
					"label": "Small"
				},
				{
					"value": "default",
					"label": "Medium (Default)"
				},
				{
					"value": "large",
					"label": "Large"
				},
				{
					"value": "xlarge",
					"label": "Extra Large"
				}
			],
			"default": "default"
		}
	],
	"presets": [
		{
			"name": "Cart page upsell"
		}
	],
	"enabled_on": {
		"templates": ["cart"]
	}
}
{% endschema %}